<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SB60 Live Standings</title>

  <style>
    :root{
      --bg:#f3f3f3; --card:#fff; --ink:#1f2937; --muted:#6b7280; --line:#e5e7eb;
      --goodBg:#dcfce7; --goodInk:#14532d;
      --badBg:#fee2e2; --badInk:#7f1d1d;
      --waitBg:#f3f4f6; --waitInk:#374151;
      --accent:#2ecc71;
      --dupBg:#fff7ed; --dupInk:#9a3412; --dupBorder:#fdba74;
      --tbBg:#eef2ff; --tbInk:#312e81; --tbBorder:#c7d2fe;
    }

    html,body{margin:0;background:var(--bg);font-family:Arial,sans-serif;color:var(--ink)}

    .wrap{max-width:1200px;margin:0 auto;padding:14px}

    .header{display:flex;justify-content:space-between;gap:12px;margin-bottom:12px}
    .title{font-size:20px;font-weight:900}
    .meta{font-size:12px;color:var(--muted);text-align:right}

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      box-shadow:0 10px 24px rgba(0,0,0,.06);
      overflow:hidden;
    }

    .toolbar{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      padding:12px;border-bottom:1px solid var(--line);
    }

    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:8px 12px;border-radius:999px;
      background:#f8fafc;border:1px solid var(--line);
      font-size:13px;color:var(--muted)
    }

    .dot{
      width:10px;height:10px;border-radius:50%;
      background:var(--accent);
      box-shadow:0 0 0 4px rgba(46,204,113,.18)
    }

    .search{margin-left:auto}
    input[type="search"]{
      padding:10px 12px;border-radius:10px;
      border:1px solid var(--line);font-size:14px
    }

    .table-wrap{overflow:auto}

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width:980px;
    }

    /* ðŸ”¥ HEADER WRAPPING (HEADERS ONLY) */
    thead th{
      position:sticky;top:0;z-index:2;
      background:#fff;
      font-size:12px;color:var(--muted);
      padding:8px 6px;
      border-bottom:1px solid var(--line);
      text-align:center;

      white-space:normal;
      word-break:break-word;
      line-height:1.1;
    }

    tbody td{
      padding:10px;
      border-bottom:1px solid var(--line);
      font-size:14px;
      white-space:nowrap;
    }

    tbody tr:hover td{background:#fafafa}

    .col-rank{width:56px}
    .col-name{width:240px;font-weight:900}
    .col-points{width:90px;font-weight:900}
    .col-tb{width:120px;font-weight:800}

    .name-wrap{display:flex;gap:8px;flex-wrap:wrap}

    .dup-badge{
      padding:4px 8px;border-radius:999px;
      font-size:11px;font-weight:800;
      color:var(--dupInk);
      background:var(--dupBg);
      border:1px solid var(--dupBorder);
    }

    /* ===== Cells ===== */
    .cell{
      display:inline-block;
      min-width:90px;
      padding:8px 10px;
      border-radius:10px;
      text-align:center;
      font-weight:800;
      border:1px solid rgba(0,0,0,.06);
      background:#fff;
      transition:background .25s,color .25s;
    }

    .good{background:var(--goodBg);color:var(--goodInk)}
    .bad{background:var(--badBg);color:var(--badInk)}
    .wait{background:var(--waitBg);color:var(--waitInk)}

    /* âœ¨ ANIMATION */
    .reveal{
      animation:pop .35s ease-out both;
    }

    @keyframes pop{
      0%{transform:scale(.92);opacity:0}
      60%{transform:scale(1.04)}
      100%{transform:scale(1);opacity:1}
    }

    .tb{background:var(--tbBg);color:var(--tbInk);border-color:var(--tbBorder)}
    .tb.wait{background:var(--waitBg);color:var(--waitInk)}

    .footer{
      padding:10px 12px;
      border-top:1px solid var(--line);
      font-size:12px;color:var(--muted);
      display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap
    }

    @media(max-width:600px){
      .header{flex-direction:column}
      table{min-width:900px}
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="header">
    <div class="title">SB60 Live Standings</div>
    <div class="meta">
      <div id="updated">Updated: â€”</div>
      <div id="status">Loadingâ€¦</div>
    </div>
  </div>

  <div class="card">
    <div class="toolbar">
      <div class="pill"><span class="dot"></span> Auto-updates every 30s</div>
      <div class="pill">Sorted: Points â†“ â€¢ Tiebreak Î” â†‘ â€¢ Name</div>
      <div class="search"><input id="q" type="search" placeholder="Search nameâ€¦" /></div>
    </div>

    <div class="table-wrap">
      <table>
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="footer">
      <div>Green = correct â€¢ Red = incorrect â€¢ Gray = pending</div>
      <div id="counts">â€”</div>
    </div>
  </div>
</div>

<script>
const SHEET_CSV_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vQvxWm5EeVD-akvWoB9ArtroL8J1nh8USmTiPdepmbp8JNS3HfQvKtOfSEcgumT4mccp95PJBJBlfix/pub?gid=1947708892&single=true&output=csv";

const RESULTS_ROW_NUMBER = 7;
const NAME_COL=0,PICKS_START_COL=1,PICKS_END_COL=15,TIE_GUESS_COL=16;
const TIEBREAK_DIFF_COL=17,POINTS_COL=18,DUP_COL=20;
const REFRESH_MS=30000;

let cachedRows=[], previousState=new Map();

const thead=document.getElementById("thead");
const tbody=document.getElementById("tbody");
const elQ=document.getElementById("q");
const elCounts=document.getElementById("counts");
const elUpdated=document.getElementById("updated");
const elStatus=document.getElementById("status");

const clean=v=>String(v??"").trim();
const toNum=v=>{const n=Number(clean(v));return Number.isFinite(n)?n:null};

function parseCSV(t){
  return t.trim().split("\n").map(r=>r.split(","));
}

function build(headers,results,rows){
  const pickCols=[...Array(PICKS_END_COL-PICKS_START_COL+1)].map((_,i)=>i+PICKS_START_COL);

  const players=rows.filter(r=>clean(r[0])).map(r=>{
    return{
      name:clean(r[0]),
      points:toNum(r[POINTS_COL])??0,
      tbdiff:toNum(r[TIEBREAK_DIFF_COL])??999999,
      dup:clean(r[DUP_COL]).toLowerCase()==="true",
      picks:pickCols.map(c=>{
        const pick=clean(r[c]);
        const ans=clean(results[c]);
        return{pick,ans,pending:!ans,correct:pick&&pick.toLowerCase()===ans.toLowerCase()}
      })
    }
  }).sort((a,b)=>b.points-a.points||a.tbdiff-b.tbdiff||a.name.localeCompare(b.name));

  thead.innerHTML="";
  const trh=document.createElement("tr");
  ["#","Name","Points","Tiebreak Î”",...pickCols.map(c=>headers[c]||"Q")].forEach(t=>{
    const th=document.createElement("th");th.textContent=t;trh.appendChild(th);
  });
  thead.appendChild(trh);

  tbody.innerHTML="";
  players.forEach((p,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${i+1}</td><td>${p.name}</td><td>${p.points}</td><td>${p.tbdiff}</td>`;
    p.picks.forEach((c,idx)=>{
      const key=p.name+"-"+idx;
      const prev=previousState.get(key);
      const now=c.pending?"wait":(c.correct?"good":"bad");

      const span=document.createElement("span");
      span.className="cell "+now;
      if(prev==="wait"&&now!=="wait") span.classList.add("reveal");
      span.textContent=c.pick||"â€”";

      previousState.set(key,now);

      const td=document.createElement("td");
      td.appendChild(span);
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });

  elCounts.textContent=`${players.length} entries`;
}

async function refresh(){
  try{
    elStatus.textContent="Loadingâ€¦";
    const res=await fetch(SHEET_CSV_URL,{cache:"no-store"});
    const text=await res.text();
    cachedRows=parseCSV(text);

    const headers=cachedRows[0];
    const results=cachedRows[RESULTS_ROW_NUMBER-1];
    const data=cachedRows.slice(RESULTS_ROW_NUMBER);

    build(headers,results,data);

    elUpdated.textContent="Updated: "+new Date().toLocaleTimeString();
    elStatus.textContent="Live";
  }catch(e){elStatus.textContent="Error"}
}

elQ.addEventListener("input",refresh);
refresh();
setInterval(refresh,REFRESH_MS);
</script>
</body>
</html>
